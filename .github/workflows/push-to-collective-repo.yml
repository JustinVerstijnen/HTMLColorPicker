name: Mirror repo

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: mirror-to-target-main
  cancel-in-progress: true

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source (repo A)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout target (repo B)
        uses: actions/checkout@v4
        with:
          repository: OWNER_OR_ORG/REPO_B
          token: ${{ secrets.COLLECTIVE_TOOLS_REPO }}
          path: target
          ref: main
          fetch-depth: 0

      - name: Sync files from source to target
        shell: bash
        run: |
          set -euo pipefail

          # Kopieer alles behalve git metadata en (optioneel) workflow-bestanden.
          # Pas excludes aan naar jouw smaak.
          rsync -a --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            ./ target/

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail
          cd target

          if git status --porcelain | grep -q .; then
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add -A
            git commit -m "Mirror from repo A: ${GITHUB_REPOSITORY}@${GITHUB_SHA}"
            git push origin HEAD:main
          else
            echo "No changes to push."
          fi
